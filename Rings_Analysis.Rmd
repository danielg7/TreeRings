---
title: "Preliminary analysis of Tree Growth Data"
output:
  html_document:
    keep_md: true
    theme: journal
    fig_caption: true
    fig.path: 'figure_rmd/'
---

Load appropriate libraries.
```{r Libraries, warning=FALSE,message=FALSE}
library(plyr)
library(ggplot2)
library(reshape2)
library(stargazer)
library(dplR)
library(ggthemes)
#library(Hmisc)
library(gridExtra)
library(lme4)
library(extrafont)

```
Set working directory and establish standards for displaying figures.
```{r workingDirectory, warning=FALSE,message=FALSE}
#setwd("/Users/danielgodwin/Dropbox/Graduate School/Dissertation/Chapter 3 - Growth/TreeRings/")

myTheme <- theme_tufte() +
  theme(
    text = element_text(family="sans", size=12),
        axis.line = element_line(size = .3)
    )

BasalDiameter_lab <- expression(paste("Basal Diameter (",
  u, m,")", sep=""))

RingWidth_lab <- expression(paste("Ring Width (",u, m,")", sep=""))

detrendedBasalDiameter_lab <- expression(paste("Detrended Basal Diameter (",
  u, m,")", sep=""))

detrendedRingWidth_lab <- expression(paste("Detrended Ring Width (",u, m,")", sep=""))

BAI_lab <- expression(paste("Basal Area Increment (",u, m,")", sep=""))


```
Read in data.

```{r ReadInData, echo=TRUE,warning=FALSE,message=FALSE}
Mellon_Sites <- read.csv("Sites/Mellon_Tree.csv")
Mellon_Species <- read.csv("MeasuredGrowth/MellonGrant/MellonGrant_Species.csv")
Mellon_Growth <- read.csv("MeasuredGrowth/MellonGrant/MellonGrant_TreeGrowth_LongForm_YearAdjusted.csv")


WRF_Rings <- read.csv("MeasuredGrowth/MellonGrant/WRF_Rings.csv"
                      ,comment.char = "#",
                      skip = 0)

WRF_Rings$Site <- "WRF"

WRF_Species <- read.csv("MeasuredGrowth/MellonGrant/WRF_Species.csv",comment.char = "#",
                      skip = 1)
```

Process weather data.

```{r wx, warning=FALSE, message=FALSE}
source("WeatherProcessor.R")
```

Subset and combine Mellon and WRF data

```{r TransformMellonData, echo=TRUE,warning=FALSE,message=FALSE}
names(Mellon_Species) <- c("Sample","Species")

Mellon_Master <- merge(Mellon_Sites,Mellon_Species, by="Sample",all = TRUE)

WRF_Rings <- merge(WRF_Rings,WRF_Species,by="Sample")
WRF_Rings <- na.omit(WRF_Rings)

Mellon_Master <- merge(Mellon_Master,Mellon_Growth,by="Sample")

Rings_Master <- rbind(Mellon_Master,WRF_Rings)
```

Calculate basal area increment.

```{r}

Rings_Master <- Rings_Master[order(Rings_Master$Sample,Rings_Master$Year),]

Rings_Master <- ddply(Rings_Master,.(Sample),mutate,RingWidthToDate = cumsum(RingWidth_um))

Rings_Master$EstBasalArea <- (Rings_Master$RingWidthToDate) * 2 * pi

```


```{r}
b <- ddply(Rings_Master,.(Sample),mutate,PreviousYear = Year - 1)

intermediateRings <- merge(Rings_Master,b,by.x = c("Sample","Year"), by.y = c("Sample","PreviousYear"),all.x=TRUE)

# Need to add in final size calculation for 2013

intermediateRings[,12] <- NULL # Remove extra year column
intermediateRings$BAI <- 
  (intermediateRings$EstBasalDiameter.y - intermediateRings$EstBasalDiameter.x)

intermediateRings$Sensitivity_step <- (intermediateRings$EstBasalDiameter.y - intermediateRings$EstBasalDiameter.x) / (intermediateRings$EstBasalDiameter.y + intermediateRings$EstBasalDiameter.x)/2

colsToKeep <- c("Sample","BAI","Site.x","Year","Species.x","Sensitivity_step")

ringsBAI <- intermediateRings[colsToKeep]

names(ringsBAI) <- c("Sample","BAI","Site","Year","Species","Sensitivity_step")

ringsBAI <- ddply(ringsBAI,.(Sample),mutate,YearOfGrowth = Year - min(Year)+1)

Rings_Master_AllWx <- merge(ringsBAI,Kruger_Wx_Combined,by.x=c("Year","Site"),by.y=c("Year","Station"))

Sensitivity <- ddply(Rings_Master_AllWx,.(Site,Species,Sample),summarize,Sensitivity = sum(Sensitivity_step))

Sensitivity_Site <- ddply(Sensitivity,.(Site,Species),summarize,Sensitivity = mean(Sensitivity))

Rings_Kruger <- subset(Rings_Master_AllWx,Site != "WRF")
Rings_WRF <- subset(Rings_Master_AllWx,Site == "WRF")
```

### Plot of Basal Area Increment by Year

```{r Fig_CrossSectinGrowthByYear, fig.height=6, fig.width=8, echo=FALSE,warning=FALSE,message=FALSE, fig.ext='png'}


EstCrossSection_Kruger <- ggplot(data = Rings_Kruger, aes(x = Year, y= BAI, factor=Sample, colour = Species))
EstCrossSection_Kruger+
  myTheme+
  scale_x_tufte(breaks = c(1990,1995,2000,2005,2010,2015))+
  ylab(BAI_lab)+
  geom_point()+
  ggtitle("Kruger National Park Samples")+
  geom_line()+
  theme(legend.position="bottom")+
  guides(col = guide_legend(ncol = 1,title.position = "top"))+
  facet_wrap(Species~Site,nrow=3)

EstCrossSection_WRF <- ggplot(data = Rings_WRF, aes(x = Year, y= BAI, factor=Sample, colour = Species))
EstCrossSection_WRF+
  myTheme+
  scale_x_tufte(breaks = c(1990,1995,2000,2005,2010,2015))+
  ylab(BAI_lab)+
  geom_point()+
  geom_line()+
  ggtitle("Wits Rural Facility Samples")+
  theme(legend.position="bottom")+
  facet_wrap(~Species,nrow=3)+
  guides(col = guide_legend(ncol = 8,title.position = "top"))
```

## Plot of BAI ~ WX

```{r Fig_BAIbyWx, fig.height=6, fig.width=8, echo=FALSE,warning=FALSE,message=FALSE, fig.ext='png'}
BAIbyAnnualRainfall_Kruger <- ggplot(data = Rings_Kruger, aes(x = AnnualPrecip, y= BAI, factor=Species, colour = Site))
BAIbyAnnualRainfall_Kruger+
  myTheme+
  ylab(BAI_lab)+
  xlab("Annual Precip")+
  geom_point()+
  stat_smooth(method="lm")+
  ggtitle("Kruger National Park Samples")+
  theme(legend.position="bottom",legend.direction="vertical")+
  guides(col = guide_legend(ncol = 2,title.position = "top"))+
  facet_wrap(Site ~ Species)


BAIbyAnnualRainfall_WRF <- ggplot(data = Rings_WRF, aes(x = AnnualPrecip, y= BAI, factor=Species, colour = Species))
BAIbyAnnualRainfall_WRF+
  myTheme+
  #scale_x_tufte()+
  ylab(BAI_lab)+
  xlab("Annual Precip")+
  geom_point()+
  stat_smooth(method="lm")+
  ggtitle("Wits Rural Facility Samples")+
  theme(legend.position="bottom",legend.direction="vertical")+
  guides(col = guide_legend(ncol = 8,title.position = "top"))+
  facet_wrap(~ Species,nrow=4)
```

### Plot of Basal Area Increment by Year of Growth

```{r Fig_BAIByYOG, fig.height=6, fig.width=8, echo=FALSE,warning=FALSE,message=FALSE, fig.ext='png'}
BAIbyYOG_Kruger <- ggplot(data = Rings_Kruger, aes(x = YearOfGrowth, y= BAI, factor=Sample, colour = Site))
BAIbyYOG_Kruger+
  myTheme+
  ylab(BAI_lab)+
  xlab("Age")+
  geom_point()+
  geom_line()+
  ggtitle("Kruger National Park Samples")+
  theme(legend.position="bottom",legend.direction="vertical")+
  guides(col = guide_legend(ncol = 2,title.position = "top"))+
  facet_wrap(Site ~ Species)


BAIbyYOG_WRF <- ggplot(data = Rings_WRF, aes(x = YearOfGrowth, y= BAI, factor=Sample, colour = Species))
BAIbyYOG_WRF+
  myTheme+
  #scale_x_tufte()+
  ylab(BAI_lab)+
  xlab("Age")+
  geom_point()+
  geom_line()+
  ggtitle("Wits Rural Facility Samples")+
  theme(legend.position="bottom",legend.direction="vertical")+
  guides(col = guide_legend(ncol = 8,title.position = "top"))+
  facet_wrap(~ Species,nrow=4)
```


```{r ACF_check, include=FALSE,eval=FALSE}
for(k in unique(Rings_Master_AllWx$Sample))
  {
  individual <- subset(Rings_Master_AllWx,Sample == k)
  print(acf(x = individual$BAI,plot = TRUE,main = paste(unique(individual$Species),unique(individual$Sample),unique(individual$Site))))
  }


```

### Relationship Between Annual Rainfall and Basal Area Increment

```{r Fig_AvgBAI_AvgWx, fig.height=6, fig.width=8, echo=FALSE,warning=FALSE,message=FALSE, fig.ext='png'}
avgBAI_WRF_WX <- na.omit(ddply(Rings_WRF,.(Species,Year),mutate,avgBAI = mean(BAI)))
avgBAI_KNP_WX <- na.omit(ddply(Rings_Kruger,.(Species,Year),mutate,avgBAI = mean(BAI)))



BAI_Wx_WRF <- ggplot(data = avgBAI_WRF_WX, aes(x = AnnualPrecip, y= avgBAI, factor=Site, colour = Species))
 BAI_Wx_WRF+
   myTheme+
   ylab("Mean Basal Area Increment")+
  xlab("Annual Precipitation (mm)")+
   geom_point()+
  ggtitle("Wits Rural Facility Samples")+
  # geom_smooth(method="glm")+
  theme(legend.position="none",legend.direction="vertical")+
  guides(col = guide_legend(ncol = 8,title.position = "top"))+
  facet_wrap(~Species)

 BAI_Wx_KNP <- ggplot(data = avgBAI_KNP_WX, aes(x = AnnualPrecip, y= avgBAI, colour = Species, group = Site))
 BAI_Wx_KNP+
   myTheme+
   ylab("Mean Basal Area Increment")+
  xlab("Annual Precipitation (mm)")+
   geom_point(size = 3)+
  ggtitle("Kruger National Park Samples")+
  geom_smooth(method="glm")+
  theme(text = element_text(size = 25),legend.position="none",legend.direction="vertical")+
  guides(col = guide_legend(ncol = 8,title.position = "top"))+
  facet_grid(Site~Species)


```


```{r Fig_BAIAndLifeWx, fig.height=6, fig.width=8, echo=FALSE,warning=FALSE,message=FALSE, fig.ext='png'}
BAI_summary_WRF <- ddply(Rings_WRF,.(Sample,Species),
                                 summarize,
                                 avgBAI = mean(BAI, na.rm = TRUE),
                                 meanLifeRainfall = mean(AnnualPrecip,na.rm = FALSE))

BAI_summary_KNP <- ddply(Rings_Kruger,.(Sample,Species),
                                 summarize,
                                 avgBAI = mean(BAI, na.rm = TRUE),
                                 meanLifeRainfall = mean(AnnualPrecip,na.rm = FALSE))



BAI_summary_WRF_plot <- ggplot(data = BAI_summary_WRF, aes(x = meanLifeRainfall, y= avgBAI, colour = Species))
 BAI_summary_WRF_plot+
   myTheme+
   ylab("Mean Basal Area Increment")+
  ggtitle("Wits Rural Facility Samples")+
  xlab("Mean Lifetime Rainfall (mm)")+
   geom_point()+
   stat_smooth(method="lm")+
  theme(legend.position="bottom",legend.direction="vertical")+
  guides(col = guide_legend(ncol = 8,title.position = "top"))+
  facet_wrap(~Species)


BAI_summary_KNP_plot <- ggplot(data = BAI_summary_KNP, aes(x = meanLifeRainfall, y= avgBAI, group = Species, factor=Species, colour = Species))
 BAI_summary_KNP_plot+
   myTheme+
   ylab("Mean Basal Area Increment")+
   geom_point()+
   ggtitle("Kruger National Park Samples")+
  xlab("Mean Lifetime Rainfall (mm)")+
   stat_smooth(method="lm")+
  theme(legend.position="bottom",legend.direction="vertical")+
  guides(col = guide_legend(ncol = 8,title.position = "top"))+
  facet_wrap(~Species)

for(k in unique(BAI_summary_KNP$Species))
  {
  l <- na.omit(subset(BAI_summary_KNP,Species == k))
  print(k)
  print(summary(lm(formula = avgBAI ~ meanLifeRainfall,data = l)))
  
  }

```


### Potential relatiosnhips between avg. rainfall and avg RWI

```{r Fig_PotentialRxnships}
wellAligned <- data.frame(Species = "Rainfall Limited, Positive", meanLifeRainfall = c(400,450,475,500,525,550,565), avgWRI = c(.5,.75,.8,1,1.7,1.8,2))

reverseAligned <- data.frame(Species = "Rainfall Limited, Negative", meanLifeRainfall = c(400,450,475,500,525,550,565), avgWRI = c(2.1,1.6,1.1,1,.5,.3,.1))

nonAligned <- data.frame(Species = "No Relationship", meanLifeRainfall = c(400,450,475,500,525,550,565), avgWRI = rnorm(n = 7, mean = 1, sd = 2))

fakeDF <- rbind(wellAligned,reverseAligned)
fakeDF <- rbind(fakeDF,nonAligned)

RWI_wx_h0_big <- ggplot(data = fakeDF, aes(x = log(meanLifeRainfall), y= log(avgWRI), group = Species, factor=Species, colour = Species))
RWI_wx_h0_big+
   theme_bw()+
  theme(text = element_text(size = 25),
  #      panel.grid.major = element_line(size = 1, colour = "grey75"),
   #     panel.grid.minor = element_line(size = 1, colour = "grey25"),
        legend.position="none",
        legend.direction="vertical")+
    ylab("log Average Ring Width Index")+
   ggtitle("")+
  xlab("log Mean Lifetime Rainfall")+
   #geom_point(size = 4)+
  scale_colour_discrete()+
  geom_smooth(size = 2, method="lm")+
  guides(col = guide_legend(ncol = 8,title.position = "top"))+
   facet_wrap(~Species, ncol=3)
   
```

### Recorded relationships between average RWI and mean rainfall

```{r RWI_wx_big,eval=FALSE}
RWI_wx_big <- ggplot(data = BAI_summary_KNP, aes(x = log(meanLifeRainfall), y= log(avgBAI), group = Species, factor=Species, colour = Species))
 RWI_wx_big+
   theme_bw()+
  theme(text = element_text(size = 25),
  #      panel.grid.major = element_line(size = 1, colour = "grey75"),
   #     panel.grid.minor = element_line(size = 1, colour = "grey25"),
        legend.position="none",
        legend.direction="vertical")+
    ylab("log Average Ring Width Index")+
   ggtitle("Kruger National Park Samples")+
  xlab("log Mean Lifetime Rainfall (mm)")+
   geom_point(size = 4)+
  scale_colour_discrete()+
 # geom_smooth(method="nls")+
  guides(col = guide_legend(ncol = 8,title.position = "top"))+
   facet_wrap(~Species, ncol=3)
   
```
### Correlations

```{r Correlations, echo=FALSE,include=FALSE,eval=FALSE}



```

Naive Growth
```{r echo=TRUE}
naive_growth <- ddply(Rings_Master_AllWx,
                      .(Species,Site,Sample),
                      summarise,
                      TotalSize = sum(BAI),
                      Age = max(YearOfGrowth),
                      meanLifeRainfall = mean(AnnualPrecip,na.rm=TRUE),
                      sumLifeRainfall = sum(AnnualPrecip,na.rm=TRUE)
                      )

naive_growth$NaiveRate <- log(naive_growth$TotalSize)/naive_growth$Age
```

```{r naiveGrowth_Plot, fig.height=6, fig.width=8, echo=FALSE,warning=FALSE,message=FALSE, fig.ext='png'}

naiveGrowth_enoughPoints <- ddply(naive_growth,.(Species),subset,length(Sample) > 3)

naiveGrowth_annual <- ggplot(data = naiveGrowth_enoughPoints, aes(x = meanLifeRainfall, y=NaiveRate, factor=Species, colour = Species))
naiveGrowth_annual+
  myTheme+
  ylab("Crude Growth Rate (log(Size) / Ring Count)")+
  #ggtitle("Wits Rural Facility Samples")+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~Species,ncol=3)+
  theme(legend.position="none",legend.direction="vertical")

for(k in unique(naive_growth$Species)){
  subSpec <- subset(naive_growth,Species == k)
  
  if(nrow(subSpec) > 3){
  print(k)
  print(summary(lm(NaiveRate ~ meanLifeRainfall,subSpec)))}
  
}
  

```


Growth Models
========
First, we subset the data.
```{r GrowthModels_subset}

COMO_sub <- subset(Rings_Master_AllWx,Species == "Colophospermum mopane")
COAP_sub <- subset(Rings_Master_AllWx,Species == "Combretum apiculatum")
TESE_sub <- subset(Rings_Master_AllWx,Species == "Terminalia sericea")

```
TESE Models
```{r teseModels,echo=FALSE,eval=FALSE}
teseLM <- glm(EstBasalDiameter ~ YearOfGrowth,data=TESE_sub,family=Gamma(link="log"))
teseLM_poly <- glm(EstBasalDiameter ~ poly(YearOfGrowth,3),data=TESE_sub,family=Gamma(link="log"))
teseLMannual <- glm(EstBasalDiameter ~ AnnualPrecip,data=TESE_sub,family=Gamma(link="log"))
teseLMwx <- glm(EstBasalDiameter ~ YearOfGrowth * AnnualPrecip,data=TESE_sub,family=Gamma(link="log"))
```
COAP Models
```{r coapModels,echo=FALSE,eval=FALSE}
coapGLM <- glm(EstBasalDiameter ~ YearOfGrowth,data=COAP_sub,family=Gamma(link="log"))
coapLM_poly <- glm(EstBasalDiameter ~ poly(YearOfGrowth,3),data=COAP_sub,family=Gamma(link="log"))
coapLMannual <- glm(EstBasalDiameter ~ AnnualPrecip,data=COAP_sub,family=Gamma(link="log"))
coapLMwx <- glm(EstBasalDiameter ~ YearOfGrowth * AnnualPrecip,data=COAP_sub,family=Gamma(link="log"))
```
COMO Models
```{r comoModels,echo=FALSE,eval=FALSE}


comoGLM <- glm(EstBasalDiameter ~ 0 + YearOfGrowth,data=COMO_sub,family=Gamma(link="log"))
comoLM_poly <- glm(EstBasalDiameter ~ poly(YearOfGrowth,3),data=COMO_sub,family=Gamma(link="log"))
comoLMannual <- glm(EstBasalDiameter ~ AnnualPrecip,data=COMO_sub,family=Gamma(link="log"))
comoLMwx <- glm(EstBasalDiameter ~ YearOfGrowth * AnnualPrecip,data=COMO_sub,family=Gamma(link="log"))
```

